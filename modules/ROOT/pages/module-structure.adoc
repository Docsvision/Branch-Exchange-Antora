= Структура модуля

МФО включает следующие компоненты:

.. Карточки:
+
* _Каталог файлов_ -- карточка для хранения контрольных сумм файлов, загруженных МФО на удаленный сервер {dv}.
* _Задание интеграции_ -- передаваемая на удаленные сервера {dv} карточка с данными синхронизируемых карточек и системной информацией.
* _Очередь событий_ -- карточка для хранения информации о событиях, инициировавших межфилиальный обмен.
* _Справочник настроек МФО_ -- карточка, содержащая настройки межфилиального обмена.
+
.. Бизнес-процессы:
+
** _Выгрузка данных удаленному серверу: Шаблон_ -- шаблон БП, обеспечивающий передачу _Заданий интеграции_ на удаленных сервер {dv}.
** _Обработка очереди входящих заданий МФО_ -- обрабатывает входящие _Задания интеграции_ на стороне _получателя_, загружает данные синхронизируемых карточек в БД.
** _Обработка очереди сообщений МФО_ -- обрабатывает _Очередь событий_, создает Задания интеграции для новых событий межфилиального обмена.
** _Регистрация события МФО_ -- добавляет в _Очереди событий_ новое событие, требующее обработки (и межфилиального обмена).
** БП, добавляющие события межфилиального обмена при исполнении заданий:
*** _Регистрация события МФО: завершено задание_,
*** _Регистрация события МФО: задание в работе_,
*** _Регистрация события МФО: задание отозвано_,
*** ""_Регистрация события МФО: запущено задани_"е",
*** _Регистрация события МФО: задание отклонено_,
*** _Регистрация события МФО: задание делегировано_,
*** _Регистрация события МФО: задание на приёмку_.
*** _Регистрация события МФО: задание на доработку_.
** БП, добавляющие события межфилиального обмена при согласовании:
*** _Регистрация события МФО: Подписание_,
*** _Регистрация события МФО: Консолидация_,
*** _Регистрация события МФО: Согласование_,
** БП, добавляющие события межфилиального обмена, требующие передачи документов УД:
*** _Регистрация события МФО: ОРД_.

Обобщённая схема взаимодействия компонентов модуля приведена на рисунке.

.Схема взаимодействия компонентов модуля
image::module-structure.png[Схема взаимодействия компонентов модуля]

. При работе с карточкой пользователь выполняет определенный сценарий, при котором должен состояться межфилиальный обмен. Примером такого сценария может служить запуск задания на согласование.
. Выполнение сценария приводит к запуску БП _Регистрация событий МФО_, который добавляет в _Очередь событий_ новое событие обмена.
. БП _Обработка очереди сообщений МФО_ выбирает новые события из очереди событий и формирует Задания интеграции. Задание формируется в соответствии со сценарием обмена, описанным в _Справочнике настроек МФО_.
+
****
_Сценарий обмена_ -- описание последовательности обработки событий обмена, которое включает несколько этапов:

* Определение адресатов -- формируется список серверов-получателей, на которые должны быть отправлены данные.
* Определение состава передачи -- формируется список отправляемых карточек.
* Выгрузка данных -- данные карточек подготавливаются для передачи на удаленный сервер {dv}.
* Загрузка данных -- полученные данные загружаются на удаленном сервере.

На каждом этапе вызывается собственный _компонент обмена_, указанный в сценарии обмена:

* Компонент определения адресатов.
* Компонент определения состава передачи.
* Компонент выгрузки.
* Компонент загрузки.
****
+
. БП _Выгрузка данных удаленному серверу_ осуществляет поиск новых _Заданий интеграции_ и передает их на удаленный сервер. Для взаимодействия с каждым сервером используется собственный БП.
+
Задания интеграции и бинарные данные файлов карточек, загруженных в _Задание интеграции_, передаются в разных потоках. БП проверяет наличие файлов на удаленном сервере по _Каталогу файлов_ и, если данные уже есть, не отправляет их повторно.
+
. БП _Обработка очереди входящих заданий МФО_ выбирает новые _Задания интеграции_ и загружает (импортирует) карточки, переданные с ним. При импорте используется _компонент загрузки_, указанный в выполняемом сценарии обмена.

* xref:bp-processing-tasks.adoc[Описание работы БП "Обработка очереди сообщений МФО"]
* xref:bp-upload.adoc[Описание работы БП "Выгрузка данных удаленному серверу"]
* xref:bp-processing-incoming.adoc[Описание работы БП "Обработка очереди входящих заданий МФО"]
