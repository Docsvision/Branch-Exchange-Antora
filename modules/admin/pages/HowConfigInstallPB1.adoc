= Настройка Справочника серверов

== Настройка коррекции времени

Если в межфилиальном обмене участвуют сервера {dv}, находящиеся в разных часовых поясах, МФО может автоматически корректировать время в заданиях, пересылаемых между серверами. Данная функция реализована для базовых сценариев, приведённых в ПРИЛОЖЕНИИ xref:Appendix_A.adoc[Список базовых сценариев обмена].

Если функция коррекции не требуется, перейдите к следующему пункту "Заполнение Справочника серверов".

Для настройки функции автоматической коррекции времени выполните перечисленные далее действия.

. Добавьте в метаданные _карточки сервера_ поле с названием "Utc":
[loweralpha]
.. В _Конструкторе разметок_ выберите вид _Карточка сервера_ (библиотека "Базовые объекты").
.. Откройте меню *Редактирование метаданных* (кнопка image:buttonmetadata.png[image]). Вид должен быть заблокирован для редактирования.
.. Создайте новую расширенную секцию типа "Struct" с произвольным названием (например, "DynamicFields").
.. Создайте в добавленной секции расширенное поле (кнопка image:buttonmetadata2.png[image]) с названием "Utc" (название важно) и типом "Int".
+
image::reflayoutserver3.png[image]
.. Сохраните изменения.
+
Инструкция по работе с расширенными метаданными приведена в документации модуля "Базовые объекты".
. Добавьте поле "Utc" в разметку _карточки сервера_:
[loweralpha]
.. Откройте разметку карточки вида _Карточка сервера_.
.. Перетащите на разметку элемент управления "Целое число".
.. Настройте элемент управления (команда *Свойства* контекстного меню) следующим образом:
+
image::reflayoutserver4.png[image]
+
Здесь в источнике данных выбрано созданное поле "Utc". Рекомендуемый диапазон значений коррекции для UTC: от -12 до +14.
+
На следующем изображение пример разметки _карточки сервера_ с новым полем.

image::reflayoutserver.png[image]
+
*Если в организации используется _Модуль репликации справочников_, то перед выполнением следующего шага инструкции синхронизируйте Справочники серверов с помощью _Модуля репликации справочников_.*
. Аналогичным образом настройте разметку _карточки сервера_ на других серверах {dv}, участвующих в обмене.

Если в организации используется _Модуль репликации справочников_, то настройки, перечисленные в следующих двух пунктах, уже были выполнены. В этом случае рекомендуется убедиться, что всё верно – повторно выполнять настройку не требуется (за исключением указания часового пояса в карточках серверов, если требуется коррекция времени).

Если _Модуль репликации справочников_ не используется – настройку нужно выполнить.

== Заполнение Справочника серверов

В Справочник серверов нужно добавить все сервера {dv}, участвующие в обмене.

. Откройте _Справочник серверов_ в Windows-клиенте.
. Нажмите кнопку image:buttons/add.png[image]. Будет открыто окно добавления сервера.
. Укажите информацию о сервере {dv}:
* Наименование – краткое название сервера.
* Полное название.
* Описание – дополнительная информация о сервере – если требуется.
* Часовой пояс – часовой пояс, в котором находится данный сервер {dv} – если нужна функция автоматической коррекции времени в передаваемых между серверами карточках.
* Адрес подключения – адрес подключения к данному серверу {dv} в формате `http://<Имя сервера {dv}>/{dv}/StorageServer/StorageServerService.asmx`.
* База данных – название базы {dv} – указывается, если обмен должен выполняться не с БД по умолчанию.
* Пользователь/ Пароль – данные учетной записи, от имени которой будет выполняться подключение к данному серверу с других серверов {dv}. Данный пользователь должен быть зарегистрирован в _Справочнике сотрудников_ и иметь права:
** на запись в справочники "Каталог файлов", "Очередь событий".
** на чтение всех справочников МФО.
+
Рекомендуется, для избежания возможных ошибок, связанных с недостаточностью прав, предоставить данному пользователю права администратора {dv}.
+
image::refserverform.png[Пример заполнения Справочника серверов]
. После заполнения данных на одном из серверов {dv}, справочник нужно скопировать на другие сервера {dv}, участвующие в обмене. Для этого можно использовать _Модуль репликации справочников_.
+
При изменении _Справочника серверов_ на одном из серверов данные изменения нужно перенести на все остальные сервера {dv}.

[NOTE]
====
[.note__title]#Важное замечание:# _Справочники серверов_ на всех серверах {dv}, участвующих в обмене, должен быть синхронизированы. Это является важным условием для корректной работы МФО.
====

== Идентификация сервера {dv}

В конфигурации сервера {dv} нужно зафиксировать идентификатор данного сервера. Идентификатор сервера необходим для работы алгоритмов загрузки и определения адресатов.

*Следующие действия вносят изменения в БД {dv}. Перед продолжением рекомендуется создать резервную копию.*

. Определите идентификатор сервера {dv}:
[loweralpha]
.. Запустите утилиту [.keyword]*{dv} Explorer* (входит в комплект инструментов разработчика "{dv} 5 Resource Kit").
.. Выберете тип карточки "Справочник серверов".
.. Перейдите в секцию "Серверы" и выберите из списка серверов текущий сервер (ориентируйтесь по полному наименованию – поле "FullName").
.. Запишите или запомните идентификатор сервера, указанный в поле "ServerId".
. Откройте БД {dv}, например, в "Microsoft SQL Server Management Studio". Пользователь должен иметь права на запись в таблицу [.keyword]*dvsys_settings*.
. Выполните скрипт, указав в переменной `@ServerID` полученный идентификатор сервера {dv}.
+
[source]
----
DECLARE @ServerID uniqueidentifier

-- Укажите здесь идентификатор данного сервера {dv}, определенный в Справочнике серверов
SET @ServerID = '00000000-0000-0000-0000-000000000000'

EXECUTE [dbo].[dvreport_get_data_{6037ce71-6fe8-4b48-9f3f-86e988642570}] 
        @ServerID
GO
----
. Перезагрузите сервер {dv}.
. Выполните аналогичные действия на всех серверах {dv}, участвующих в обмене.
