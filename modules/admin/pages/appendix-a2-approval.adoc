= Приложение A.2. Распределенное согласование

Сценарий _Распределенное согласование_ реализует отправку заданий согласования для исполнителей, находящихся в удаленном офисе. Данный сценарий формируется с использованием нескольких _сценариев обмена_, приведённых ниже.

[NOTE]
====
Данными сценариями поддерживается функция коррекции времени для загружаемых заданий -- в настройках сервером должен быть указан часовой пояс.
====

[#approval]
== Сценарий "Согласование"

Данный сценарий запускается при переходе задания _На согласование_ в одно из следующих состояний:

* `Не начато`.
* `Делегировано`.
* `Завершено`.
* `Возврат с делегирования`.
* `Отозвано`.
* `Отклонено`.

.Описание сценария обмена
[cols="34%,66%",options="header"]
|===
|Этап |Действие

|Определение адресатов
|Логика выбора адресата приведена в таблице "<<addressees,Определение адресатов и состава передачи">>

|Определение состава передачи
|Логика определения состава передачи приведена в таблице "<<addressees,Определение адресатов и состава передачи">>

|Выгрузки
|Формирует из каждой карточки, подготовленной к отправке, xml-документ.

|Загрузки 
a|Если сервера отправителя и получателя находятся в разных часовых поясах, то будет произведена соответствующая коррекция времени исполнения задания и прочих значений, привязанных к точному времени.

При загрузке заданий с состоянием `Не начато`, `Делегировано` и `Возврат с делегирования`, будет произведена рассылки заданий на электронную почту.

Логика разрешения конфликтов приведена в таблице "<<conflicts,Схема разрешения конфликтов>>"

|===

== Сценарий "Подписание"

Данный сценарий запускается при переходе задания _На подписание_ в одно из следующих состояний:

* `Не начато`.
* `Делегировано`.
* `Завершено`.
* `Возврат с делегирования`.
* `Отозвано`.
* `Отклонено`.

.Описание сценария обмена
[cols="34%,66%",options="header"]
|===
|Этап |Действие

|Определение адресатов
|Логика выбора адресата приведена в таблице "<<addressees,Определение адресатов и состава передачи">>

|Определение состава передачи
|Логика определения состава передачи приведена в таблице "<<addressees,Определение адресатов и состава передачи">>

|Выгрузки
|Формирует из каждой карточки, подготовленной к отправке, xml-документ.

|Загрузки
a|Если сервера отправителя и получателя находятся в разных часовых поясах, то будет произведена соответствующая коррекция времени исполнения задания и прочих значений, привязанных к точному времени.

При загрузке заданий с состоянием `Не начато`, `Делегировано` и `Возврат с делегирования`, будет произведена рассылки заданий на электронную почту.

Логика разрешения конфликтов приведена в таблице "<<conflicts,Схема разрешения конфликтов>>"

|===

[#addressees]
== Определение адресатов и состава передачи

Определение получателей _Заданий интеграции_ производится по таблице приведенной далее.

.Определение адресатов и состава передачи
[cols="20%,45%,35%",options="header"]
|===
|Состояние |Адресат |Состав передачи

|Не начато, Делегировано
|В список _получателей_ добавляются сервера текущих исполнителей.
a|В выгрузку включены:

* Задание.
* Список подчиненных заданий.
* Карточка согласования.
* Карточка этапа.
* Карточка маршрута.
* Список ссылок.
* Список подписей.
* Списки файлов задания.
* Связанные документы с их файлами, категориями, списками ссылок и файлов.

.2+|Завершено
|В список _получателей_ добавляется сервер автора.
a|В выгрузку включены:

* Задание.
* Список подчиненных заданий.
* Карточка согласования.
* Карточка этапа.
* Карточка маршрута.
* Список ссылок.
* Список подписей.
* Списки файлов задания.
* Связанные документы с их файлами, категориями, списками ссылок и файлов.

|В список _получателей_ добавляются сервера текущих исполнителей.
|Карточка задания
|Возврат с делегирования
|В список _получателей_ добавляются сервера текущих исполнителей.
a|В выгрузку включены:

* Задание.
* Список подчиненных заданий.
* Карточка согласования.
* Карточка этапа.
* Карточка маршрута.
* Список ссылок.
* Список подписей.
* Списки файлов задания.
* Связанные документы с их файлами, категориями, списками ссылок и файлов.

|Отозвано
|В список _получателей_ добавляются сервера текущих исполнителей.

|Карточка задания
|Отклонено

|В список _получателей_ добавляется сервер автора.
|Карточка задания

|===

[#conflicts]
== Стандартные правила разрешения конфликтов по состояниям

Ниже приведена Схема разрешения конфликтов при загрузке данных у _Получателя_. На пересечении состояний используется условное обозначение: `+` -- данные перезаписываются на новые, `-` -- перезапись не выполняется.

.Схема разрешения конфликтов
[cols=",,,,,,"]
|===
| 6+|Состояние задания у Получателя

|Состояние импортируемой карточки |Подготовка |Не начато |Отклонено |Отложено |Отозвано |В работе

|Не начато |- |+ |+ |+ |+ |-
|Отклонено |- |+ |- |+ |- |+
|Отозвано |- |+ |+ |+ |- |+
|Делегировано |- |+ |- |+ |- |+
|Возврат с делегирования |- |+ |- |+ |- |+
|На приёмке |- |+ |- |+ |- |+
|На доработке |- |+ |- |+ |- |+
|Завершено |- |+ |- |+ |- |+

|===

.Продолжение таблицы "Схема разрешения конфликтов"
[cols=",,,,,"]
|===
| 5+|Состояние задания у Получателя

|Состояние импортируемой карточки |Делегировано |Возврат с делегирования |На приёмке |На доработке |Завершено

|Не начато |- |- |- |- |-
|Отклонено |+ |+ |- |- |-
|Отозвано |+ |+ |+ |+ |-
|Делегировано |+ |+ |- |- |-
|Возврат с делегирования |+ |+ |- |- |-
|На приёмке |+ |+ |- |+ |-
|На доработке |+ |+ |+ |- |-
|Завершено |+ |+ |+ |+ |-

|===

Адресат согласования выбирается исходя из текущего состояния карточки, что позволяет избежать дублирования согласования при рассылке _Заданий интеграции_. Схема исключения конфликтов позволяет избежать некорректного изменения статуса карточки на всех этапах согласования.
