= Настройка Справочника серверов

[#time]
== Настройка коррекции времени

Если в межфилиальном обмене участвуют сервера {dv}, находящиеся в разных часовых поясах, МФО может автоматически корректировать время в заданиях, пересылаемых между серверами. Данная функция реализована для базовых сценариев, приведённых в ПРИЛОЖЕНИИ xref:appendix-a-scenarios.adoc[Список базовых сценариев обмена].

Если функция коррекции не требуется, перейдите к пункту <<fill,Заполнение Справочника серверов>>.

.Выполните перечисленные далее действия, чтобы настроить функции автоматической коррекции времени:
. Добавьте в метаданные _карточки сервера_ поле с названием `Utc`:
.. В _Конструкторе разметок_ выберите вид _Карточка сервера_ из библиотеки _{bo}_.
.. Откройте меню _Редактирование метаданных_ кнопкой image:new.png[Новый лист]. Вид должен быть заблокирован для редактирования.
.. Создайте новую расширенную секцию типа `Struct` с произвольным названием, например, `DynamicFields`.
.. Создайте в добавленной секции расширенное поле кнопкой image:plus-green-thin.png[Узкий зелёный плюс]) с названием `Utc` (название важно) и типом `Int`.
+
.Создание расширенного поля
image::create-dynamic-field.png[Создание расширенного поля]
+
.. Сохраните изменения.
+
Инструкция по работе с расширенными метаданными приведена в документации модуля _{bo}_, раздел "xref:5.5.5@backoffice:desdirs:layouts/edit-extended-metadata.adoc[]".
+
. Добавьте поле `Utc` в разметку _карточки сервера_:
.. Откройте разметку карточки вида _Карточка сервера_.
.. Перетащите на разметку элемент управления "Целое число".
.. Настройте элемент управления, вызвав команду _Свойства_ из контекстного меню:
+
.Свойства элемента управления
image::control-properties.png[Свойства элемента управления]
+
Здесь в источнике данных выбрано созданное поле `Utc`. Рекомендуемый диапазон значений коррекции для UTC: от -12 до +14.
+
На следующем изображение пример разметки _карточки сервера_ с новым полем.
+
.Разметка карточки сервера с добавленным полем
image::server-card-layout.png[Разметка карточки сервера с добавленным полем]
+
[WARNING]
====
Если в организации используется _xref:replication::index.adoc[Модуль репликации справочников]_, то перед выполнением следующего шага инструкции синхронизируйте Справочники серверов с помощью _Модуля репликации справочников_.
====
+
. Аналогичным образом настройте разметку _карточки сервера_ на других серверах {dv}, участвующих в обмене.
+
. Если _xref:replication::index.adoc[Модуль репликации справочников]_ не используется, требуется выполнить настройки в пунктах <<fill,Заполнение Справочника серверов>> и <<identify,Идентификация сервера {dv}>>.
+
****
Если в организации используется _Модуль репликации справочников_, настройки, перечисленные в следующих двух пунктах, уже были выполнены. В этом случае рекомендуется убедиться, что всё верно -- повторно выполнять настройку не требуется, за исключением указания часового пояса в карточках серверов, если требуется коррекция времени.
****

[#fill]
== Заполнение Справочника серверов

В Справочник серверов нужно добавить все сервера {dv}, участвующие в обмене.

. Откройте _Справочник серверов_ в Windows-клиенте.
. Нажмите кнопку image:buttons/plus-green.png[Зелёный плюс]. Будет открыто окно добавления сервера.
. Укажите информацию о сервере {dv}:
+
* _Наименование_ -- краткое название сервера.
* _Полное название_.
* _Описание_ -- дополнительная информация о сервере, если требуется.
* _Часовой пояс_ -- часовой пояс, в котором находится данный сервер {dv}, если нужна функция автоматической коррекции времени в передаваемых между серверами карточках.
* _Адрес подключения_ -- адрес подключения к данному серверу {dv} в формате `http://Имя-сервера-{dv}/{dv}/StorageServer/StorageServerService.asmx`.
* _База данных_ -- название базы {dv} -- указывается, если обмен должен выполняться не с БД по умолчанию.
* _Пользователь_/_Пароль_ -- данные учетной записи, от имени которой будет выполняться подключение к данному серверу с других серверов {dv}. Данный пользователь должен быть зарегистрирован в _Справочнике сотрудников_ и иметь права:
** На запись в справочники _Каталог файлов_, _Очередь событий_.
** На чтение всех справочников МФО.
+
Во избежание возможных ошибок, связанных с недостаточностью прав, рекомендуется предоставить данному пользователю права администратора {dv}.
+
.Пример заполнения Справочника серверов
image::server-directory-filled.png[Пример заполнения Справочника серверов]
+
. После заполнения данных на одном из серверов {dv}, справочник нужно скопировать на другие сервера {dv}, участвующие в обмене. Для этого можно использовать _xref:replication::index.adoc[Модуль репликации справочников]_.
+
При изменении _Справочника серверов_ на одном из серверов данные изменения нужно перенести на все остальные сервера {dv}.
+
[WARNING]
====
_Справочники серверов_ на всех серверах {dv}, участвующих в обмене, должны быть синхронизированы. Это является важным условием для корректной работы модуля МФО.
====

[#identify]
== Идентификация сервера {dv}

В конфигурации сервера {dv} нужно зафиксировать идентификатор данного сервера. Идентификатор сервера необходим для работы алгоритмов загрузки и определения адресатов.

[WARNING]
====
Следующие действия вносят изменения в БД {dv}. Перед продолжением рекомендуется создать резервную копию.
====

. Определите идентификатор сервера {dv}:
.. Запустите утилиту _{dv} Explorer_ входит в комплект инструментов разработчика "{dv} 5 Resource Kit".
.. Выберете тип карточки _Справочник серверов_.
.. Перейдите в секцию _Серверы_ и выберите из списка серверов текущий сервер (ориентируйтесь по полному наименованию -- поле `FullName`).
.. Запишите или запомните идентификатор сервера, указанный в поле `ServerId`.
. Откройте БД {dv}, например, в {mssql} Management Studio. Пользователь должен иметь права на запись в таблицу *dvsys_settings*.
. Выполните скрипт, указав в переменной `@ServerID` полученный идентификатор сервера {dv}.
+
[source,sql]
----
DECLARE @ServerID uniqueidentifier

SET @ServerID = '00000000-0000-0000-0000-000000000000' <.>

EXECUTE [dbo].[dvreport_get_data_{6037ce71-6fe8-4b48-9f3f-86e988642570}] 
        @ServerID
GO
----
<.> Укажите здесь идентификатор данного сервера {dv}, определенный в Справочнике серверов
+
. Перезагрузите сервер {dv}.
. Выполните аналогичные действия на всех серверах {dv}, участвующих в обмене.
