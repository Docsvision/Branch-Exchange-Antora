[[ariaid-title1]]
== Структура модуля

МФО включает следующие компоненты:

* Карточки:
** [.dfn .term]_Каталог файлов_ – карточка для хранения контрольных сумм файлов, загруженных МФО на удаленный сервер Docsvision;
** [.dfn .term]_Задание интеграции_ – передаваемая на удаленные сервера Docsvision карточка с данными синхронизируемых карточек и системной информацией;
** [.dfn .term]_Очередь событий_ – карточка для хранения информации о событиях, инициировавших межфилиальный обмен;
** [.dfn .term]_Справочник настроек МФО_ – карточка, содержащая настройки межфилиального обмена.
* Бизнес-процессы:
** «Выгрузка данных удаленному серверу: Шаблон» – шаблон БП, обеспечивающий передачу [.dfn .term]_Заданий интеграции_ на удаленных сервер Docsvision;
** «Обработка очереди входящих заданий МФО» – обрабатывает входящие [.dfn .term]_Задания интеграции_ на стороне [.dfn .term]_получателя_, загружает данные синхронизируемых карточек в БД;
** «Обработка очереди сообщений МФО» – обрабатывает [.dfn .term]_Очередь событий_, создает Задания интеграции для новых событий межфилиального обмена;
** «Регистрация события МФО» – добавляет в [.dfn .term]_Очереди событий_ новое событие, требующее обработки (и межфилиального обмена);
** БП, добавляющие события межфилиального обмена при исполнении заданий:
*** «Регистрация события МФО: завершено задание»,
*** «Регистрация события МФО: задание в работе»,
*** «Регистрация события МФО: задание отозвано»,
*** «Регистрация события МФО: запущено задание»,
*** «Регистрация события МФО: задание отклонено»,
*** «Регистрация события МФО: задание делегировано»,
*** «Регистрация события МФО: задание на приёмку»;
*** «Регистрация события МФО: задание на доработку»;
** БП, добавляющие события межфилиального обмена при согласовании:
*** «Регистрация события МФО: Подписание»,
*** «Регистрация события МФО: Консолидация»,
*** «Регистрация события МФО: Согласование»,
** БП, добавляющие события межфилиального обмена, требующие передачи документов УД:
*** «Регистрация события МФО: ОРД».

Обобщённая схема взаимодействия компонентов модуля приведена на рисунке.

image::img/modschema.png[[.fig--title-label]##Рис. 1. ##Схема взаимодействия компонентов модуля]

. При работе с карточкой пользователь выполняет определенный сценарий, при котором должен состояться межфилиальный обмен. Примером такого сценария может служить запуск задания на согласование.
. Выполнение сценария приводит к запуску БП «Регистрация событий МФО», который добавляет в [.dfn .term]_Очередь событие_ новое событие обмена.
. БП «Обработка очереди сообщений МФО» выбирает новые события из очереди событий и формирует Задания интеграции. Задание формируется в соответствии со сценарием обмена, описанным в [.dfn .term]_Справочнике настроек МФО_.
+
Сценарий обмена – описание последовательности обработки событий обмена, которое включает несколько этапов:

* определение адресатов – формируется список серверов-получателей, на которые должны быть отправлены данные;
* определение состава передачи – формируется список отправляемых карточек;
* выгрузки данных – данные карточек подготавливаются для передачи на удаленный сервер Docsvision;
* загрузки данных – полученные данные загружаются на удаленном сервере.

На каждом этапе вызывается собственный [.dfn .term]_компонент обмена_, указанный в сценарии обмена:

* компонент определения адресатов;
* компонент определения состава передачи;
* компонент выгрузки;
* компонент загрузки.
. БП «Выгрузка данных удаленному серверу» осуществляет поиск новых Заданий интеграции и передает их на удаленный сервер. Для взаимодействия с каждым сервером используется собственный БП.
+
Задания интеграции и бинарные данные файлов карточек, загруженных в Задание интеграции, передаются в разных потоках. БП проверяет наличие файлов на удаленном сервере по Каталогу файлов и, если данные уже есть, не отправляет их повторно.
. БП «Обработка очереди входящих заданий МФО» выбирает новые Задания интеграции и загружает импортирует карточки, переданные с ним. При импорте используется [.dfn .term]_компонент загрузки_, указанный выполняемом сценарии обмена.

* *xref:../topics/QueueListProcess.adoc[Описание работы БП «Обработка очереди сообщений МФО»]* +
* *xref:../topics/ArchitectureSenderTask.adoc[Описание работы БП «Выгрузка данных удаленному серверу»]* +
* *xref:../topics/ArchitectureImporterTask.adoc[Описание работы БП «Обработка очереди входящих заданий МФО»]* +
